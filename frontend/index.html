<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Laptop Insights ‚Äî Explorer</title>
<style>
  :root{
    --card-bg:#fff; --muted:#6b7280; --accent:#2563eb; --price:#0ea5a4;
    --radius:10px; --shadow:0 6px 18px rgba(15,23,42,0.08);
    font-family:Inter, ui-sans-serif, system-ui;
  }
  body{background:#f3f4f6;margin:0;padding:24px;color:#111;}
  .container{max-width:1100px;margin:0 auto;text-align:center}

  /* Title */
  h1{margin:0;font-size:28px;font-weight:800}
  .subtitle{color:var(--muted);margin-top:4px;margin-bottom:20px}

  /* Action buttons */
  .action-buttons{display:flex;justify-content:center;gap:12px;margin-top:16px;margin-bottom:24px}
  .btn{background:var(--accent);color:#fff;padding:10px 18px;border-radius:10px;border:none;cursor:pointer;font-size:15px;font-weight:600}
  .btn.secondary{background:#eef2ff;color:var(--accent)}
  .btn:disabled{opacity:0.5;cursor:not-allowed}

  /* Filter panel */
  .panel{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-top:16px;text-align:left}
  .filters{display:flex;gap:20px;flex-wrap:wrap;justify-content:center}

  label{font-size:14px;color:#111;font-weight:600;display:flex;flex-direction:column;align-items:flex-start}
  input[type="number"]{padding:6px;border-radius:6px;border:1px solid #e5e7eb;width:110px;margin-top:6px}
  select{padding:6px;border-radius:6px;border:1px solid #e5e7eb;margin-top:6px}

  #results{margin-top:20px}
  .muted{color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:16px}
  .card{background:var(--card-bg);padding:18px;border-radius:12px;box-shadow:var(--shadow);}
  .brand{font-weight:700}
  .model{color:var(--muted);margin-bottom:8px}
  .price{font-weight:900;font-size:20px;color:var(--price);margin-top:10px}

  /* Chatbot center UI */
  #chatSection{display:none;max-width:550px;margin:0 auto;background:#fff;border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
  #chatBody{height:250px;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px;background:#f8fafc;border-radius:10px;margin-bottom:12px}
  .message{background:#e5e7eb;padding:10px;border-radius:10px;align-self:flex-start;max-width:75%;white-space:pre-wrap}
  .message.user{background:#dbeafe;align-self:flex-end}
  .message.assistant{background:#f0fdf4}
  .message.error{background:#fee2e2;color:#991b1b}
  .loading{text-align:center;color:var(--muted);font-style:italic}
  textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #d1d5db;resize:vertical}

  .status{text-align:center;padding:10px;margin-bottom:10px;border-radius:8px;font-size:14px}
  .status.connected{background:#d1fae5;color:#065f46}
  .status.error{background:#fee2e2;color:#991b1b}

  @media(max-width:800px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="container">

  <!-- TITLE SECTION -->
  <h1>Laptop Insights ‚Äî Explorer</h1>
  <div class="subtitle">Explore canonical specs (PDF) + live marketplace data</div>

  <!-- ACTION BUTTONS -->
  <div class="action-buttons">
    <button id="recBtn" class="btn secondary">Recommend</button>
    <button id="chatBtn" class="btn">Chat AI</button>
  </div>

  <!-- RECOMMEND SECTION (filters + results) -->
  <div id="recommendSection" style="display:none">
    <div class="panel">
      <div class="filters">

        <label>Brand
          <select id="brand">
            <option value="">Any</option>
            <option value="Lenovo">Lenovo</option>
            <option value="HP">HP</option>
          </select>
        </label>

        <label>Min Price
          <input type="number" id="minPrice" value="0">
        </label>

        <label>Max Price
          <input type="number" id="maxPrice" value="0">
        </label>

        <label>Rating
          <select id="minRating">
            <option value="0">Any</option>
            <option value="1">1+</option>
            <option value="2">2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
          </select>
        </label>

        <button id="applyFilters" class="btn">Apply</button>
        <button id="resetFilters" class="btn secondary">Reset</button>

      </div>
    </div>

    <div id="results"></div>
  </div>

  <!-- CHATBOT SECTION -->
  <div id="chatSection">
    <div style="font-size:20px;font-weight:700;margin-bottom:10px">AI Chat</div>
    <div id="apiStatus"></div>
    <div id="chatBody"></div>
    <textarea id="chatInput" rows="2" placeholder="Ask about the 4 business laptops..."></textarea>
    <button id="sendChat" class="btn" style="margin-top:10px;width:100%">Send</button>
  </div>

</div>

<script>
// ============================================
// CONFIGURATION - UPDATE THIS URL IF NEEDED
// ============================================
const API_BASE_URL = "http://localhost:8000";

const CATALOG = [
  {brand:"Lenovo",model:"ThinkPad E14 Gen 5 (Intel)",price:999,rating:4.5,display:"14-inch FHD",processor:"i5-1335U",memory:"8GB",storage:"256GB"},
  {brand:"Lenovo",model:"ThinkPad E14 Gen 5 (AMD)",price:949,rating:4.3,display:"14-inch FHD",processor:"Ryzen 5",memory:"8GB",storage:"512GB"},
  {brand:"HP",model:"ProBook 450 G10",price:899,rating:4.1,display:"15.6-inch FHD",processor:"i5-1235U",memory:"8GB",storage:"256GB"},
  {brand:"HP",model:"ProBook 440 G11",price:799,rating:3.9,display:"14-inch FHD",processor:"i3-1215U",memory:"8GB",storage:"256GB"}
];

// Get DOM elements
const recBtn = document.getElementById("recBtn");
const chatBtn = document.getElementById("chatBtn");
const recSec = document.getElementById("recommendSection");
const chatSec = document.getElementById("chatSection");
const results = document.getElementById("results");
const chatBody = document.getElementById("chatBody");
const chatInput = document.getElementById("chatInput");
const sendBtn = document.getElementById("sendChat");
const apiStatus = document.getElementById("apiStatus");

// ============================================
// UI SWITCHING
// ============================================
recBtn.onclick = () => {
  chatSec.style.display = "none";
  recSec.style.display = "block";
  results.innerHTML = "";
};

chatBtn.onclick = async () => {
  recSec.style.display = "none";
  chatSec.style.display = "block";
  await checkAPIStatus();
};

// ============================================
// FILTER LOGIC (RECOMMEND SECTION)
// ============================================
function applyFilters(){
  const brand = document.getElementById("brand").value;
  const minP = Number(document.getElementById("minPrice").value||0);
  const maxP = Number(document.getElementById("maxPrice").value||0);
  const minR = Number(document.getElementById("minRating").value||0);

  const filtered = CATALOG.filter(l => {
    if(brand && l.brand !== brand) return false;
    if(l.price < minP) return false;
    if(maxP>0 && l.price > maxP) return false;
    if(l.rating < minR) return false;
    return true;
  });

  render(filtered);
}

function render(list){
  if(list.length === 0){
    results.innerHTML = `<div class='muted'>No results</div>`;
    return;
  }
  results.innerHTML = `<div class='grid'>` + list.map(l=>`
      <div class='card'>
        <div class='brand'>${l.brand}</div>
        <div class='model'>${l.model}</div>
        <div>Rating: ${l.rating} ‚≠ê</div>
        <div>Processor: ${l.processor}</div>
        <div>Memory: ${l.memory}</div>
        <div>Storage: ${l.storage}</div>
        <div class='price'>$${l.price}</div>
      </div>
    `).join("") + `</div>`;
}

document.getElementById("applyFilters").onclick = applyFilters;

document.getElementById("resetFilters").onclick = () => {
  document.getElementById("brand").value = "";
  document.getElementById("minPrice").value = 0;
  document.getElementById("maxPrice").value = 0;
  document.getElementById("minRating").value = 0;
  results.innerHTML = "";
};

// ============================================
// CHAT FUNCTIONALITY - REAL API INTEGRATION
// ============================================

async function checkAPIStatus() {
  try {
    console.log("Checking API status at:", API_BASE_URL);
    const response = await fetch(`${API_BASE_URL}/`);
    
    if (response.ok) {
      const data = await response.json();
      console.log("API response:", data);
      apiStatus.innerHTML = `<div class="status connected">‚úì Connected to API</div>`;
    } else {
      console.error("API returned error:", response.status);
      apiStatus.innerHTML = `<div class="status error">‚ö† API returned error: ${response.status}</div>`;
    }
  } catch (error) {
    console.error("Connection error:", error);
    apiStatus.innerHTML = `<div class="status error">‚ö† Cannot connect to API at ${API_BASE_URL}<br>Error: ${error.message}</div>`;
  }
}

function appendMessage(text, type = "assistant") {
  const div = document.createElement("div");
  div.className = `message ${type}`;
  div.textContent = text;
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function showLoading() {
  const div = document.createElement("div");
  div.className = "loading";
  div.id = "loadingMessage";
  div.textContent = "ü§ñ AI is thinking...";
  chatBody.appendChild(div);
  chatBody.scrollTop = chatBody.scrollHeight;
}

function hideLoading() {
  const loading = document.getElementById("loadingMessage");
  if (loading) loading.remove();
}

async function sendMessage() {
  const question = chatInput.value.trim();
  if (!question) {
    alert("Please type a message first!");
    return;
  }

  console.log("Sending message:", question);

  // Disable send button to prevent multiple clicks
  sendBtn.disabled = true;
  
  // Display user message
  appendMessage(question, "user");
  chatInput.value = "";
  
  // Show loading indicator
  showLoading();

  try {
    console.log("Making API call to:", `${API_BASE_URL}/chat`);
    
    const response = await fetch(`${API_BASE_URL}/chat`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ question: question })
    });

    console.log("Response status:", response.status);
    
    hideLoading();

    if (!response.ok) {
      throw new Error(`API error: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    console.log("API response data:", data);
    
    if (data.answer) {
      appendMessage(data.answer, "assistant");
    } else {
      appendMessage("Received empty response from API", "error");
    }

  } catch (error) {
    console.error("Chat error:", error);
    hideLoading();
    appendMessage(`‚ùå Error: ${error.message}\n\nPlease make sure:\n1. Backend is running on ${API_BASE_URL}\n2. CORS is enabled\n3. Ollama is installed and running`, "error");
  } finally {
    // Re-enable send button
    sendBtn.disabled = false;
    chatInput.focus();
  }
}

// Event listeners
sendBtn.onclick = sendMessage;

// Allow Enter key to send (Shift+Enter for new line)
chatInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Debug info on load
console.log("Frontend loaded. API URL:", API_BASE_URL);
</script>
</body>
</html>